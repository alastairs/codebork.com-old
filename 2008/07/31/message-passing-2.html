<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CodeBork | Message Passing 2</title>
  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta property="og:title" content="Message Passing 2">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://codebork.com/2008/07/31/message-passing-2.html">
  <meta property="og:description" content="">
  <meta property="og:site_name" content="CodeBork">
  <meta property="og:image" content="http://codebork.com/assets/og-image.jpg">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:url" content="http://codebork.com/2008/07/31/message-passing-2.html">
  <meta name="twitter:title" content="Message Passing 2">
  <meta name="twitter:description" content="">
  <meta name="twitter:image" content="http://codebork.com/assets/og-image.jpg">

  <link rel="apple-touch-icon" href="/assets/apple-touch-icon.png">
  <link href="http://codebork.comfeed.xml" type="application/rss+xml" rel="alternate" title="CodeBork Last 10 blog posts" />

  
    <link type="text/css" rel="stylesheet" href="/assets/light.css">
  
</head>

<body>
  <main role="main">
    <div class="grid grid-centered">
      <div class="grid-cell">
        <nav class="header-nav reveal">
  <a href="/" class="header-logo" title="CodeBork">CodeBork</a>
  <ul class="header-links">
    
      <li>
        <a href="http://twitter.com/alastairs" target="_blank" title="Twitter">
          <span class="icon icon-social-twitter"></span>
        </a>
      </li>
    
    
    
      <li>
        <a href="alastairs" target="_blank" title="GitHub">
          <span class="icon icon-social-github"></span>
        </a>
      </li>
    
    
    
    
    
      <li>
        <a href="mailto:codebork@alastairsmith.me.uk" target="_blank" title="Email">
          <span class="icon icon-at"></span>
        </a>
      </li>
    
    
      <li>
        <a href="/feed.xml" target="_blank" title="RSS">
          <span class="icon icon-social-rss"></span>
        </a>
      </li>
    
  </ul>
</nav>

        <article class="article reveal">
          <header class="article-header">
            <h1>Message Passing 2</h1>
            <p></p>
            <div class="article-list-footer">
              <span class="article-list-date">
                July 31, 2008
              </span>
              <span class="article-list-divider">-</span>
              <span class="article-list-minutes">
                
                
                  3 minute read
                
              </span>
              <span class="article-list-divider">-</span>
              <div class="article-list-tags">
                
              </div>
            </div>
          </header>

          <div class="article-content">
            <p>As a follow-up to my previous post on <a href="http://www.alastairsmith.me.uk/coding/2008/06/25/message-passing-a-plug-framework.html">message passing in a plug-in framework</a>, I thought I’d post my solution to the problem.  Now that I’ve finally reached a solution, that is…!</p>

<p>[<strong>Note</strong>: It would be worth reading the first post to get an idea of what I was trying to do.  ]</p>

<p>[img_assist|nid=26|title=|desc=|link=node|align=none|width=480|height=318]
<!--break-->
As you may recall, I was investigating a number of ways of passing messages in my plug-in framework, and was trying to settle on the built-in .NET event system as the underlying mechanism.  Whilst discussing this with my friend and colleague <a href="http://www.analysisuk.com/blog/" title="Steve's personal blog">Steve Harrison</a>, he suggested that I look into the <a href="http://msdn.microsoft.com/en-us/library/system.componentmodel.inotifypropertychanged.aspx">INotifyPropertyChanged interface</a> provided as part of the .NET System.ComponentModel namespace.</p>

<p>Despite my earlier misgivings about using events in this way, this turned out to be very useful!  Rather than having to declare my own event types, etc., I simply implement the interface as follows:</p>

<blockcode language="csharp">
public class Plugin : IPlugin, INotifyPropertyChanged
{
    // Implement IPlugin to identify this as a plugin
    ...

    // Implement INotifyPropertyChanged to publish events
    public event PropertyChangedEventHandler PropertyChanged;
}
</blockcode>

<p>Easy-peasy — one line of code!</p>

<p>Now, ideally, listening plug-ins would then subscribe directly to the events published by other plug-ins, but there’s no way of doing this in a de-coupled framework.  How does a listening plug-in know what events are available for subscription, or which plug-ins are publishing events?</p>

<p>To get around this, I introduced IMessageBroker (and an associated implementation):</p>
<blockcode language="csharp">
public interface IMessageBroker
{
    IDictionary&lt;IPlugin, IList<EventInfo>&gt; Events { get; }
    void Initialise(ILog logger);
    void RegisterEvents(IPlugin publisher, EventInfo[] publishedEvents);
    void DeregisterEvents(IPlugin publisher, EventInfo[] publishedEvents);
    void Subscribe(IPlugin publisher, EventInfo e, Delegate handler);
    void Unsubscribe(IPlugin publisher, EventInfo e, Delegate handler);
    IList<EventInfo> GetSubscribedEvents(IPlugin subscriber);
}
&lt;/blockcode&gt;

As you can see, the message broker serves registration-type requests (from plug-ins publishing events) and subscription-type requests (from plug-ins listening to events).  The <a href="http://msdn.microsoft.com/en-us/library/system.reflection.eventinfo.aspx" title="EventInfo Class (System.Reflection)">EventInfo class</a> is provided as part of the Reflection feature in C#/.NET, and does exactly what it says on the tin: it provides access to metadata on the event, and can mediate subscriptions.  Using Reflection, a plug-in passes an array of the events it publishes to the message broker, which then stores it in a dictionary (or map for the Java-types out there) of events, indexed by publisher.  Subscribe takes a publisher, an event and an event handler and creates the publish/subscribe relationship between the two plug-ins using the <a href="http://msdn.microsoft.com/en-us/library/system.reflection.eventinfo.addeventhandler.aspx" title="EventInfo.AddEventHandler Method (System.Reflection)">AddEventHandler method</a>.  

Handily, the broker is flexible enough to be able to subscribe any PropertyChangedEventHandler delegate to registered events &mdash; it doesn't have to be part of a plug-in.  This was doubly useful when testing:
<blockcode language="csharp">
public void SendMessageTest()
{
    // Subscribe to the event with a test handler
    PropertyChangedEventHandler propertyChanged = 
        new PropertyChangedEventHandler(PropertyChangedHandler);
    mb.Subscribe(eventPlugin, mb.Events[eventPlugin][0], propertyChanged);

    // Fire the event
    ...

    if (!handlerRun)
    {
        Assert.Fail("PropertyChangedHandler not run");
    }
}

public void PropertyChangedHandler(object sender, PropertyChangedEventArgs e)
{
    Trace.WriteLine("PropertyChangedHandler was successfully called");
    Trace.WriteLine(String.Format("Arguments passed were: {0}, {1}", sender, e));
    handlerRun = true;
}
</blockcode>

So, to summarise and conclude.  The approach I took was a little more complex than might usually be the case in a publish/subscribe model, but this was dictated by the nature of the system.  The use of the INotifyPropertyChanged interface greatly simplified the implementation of the events, and Reflection allowed me to dynamically pass around information about events rather than having to explicitly state it.  The INotifyPropertyChanged pattern also gives me a model on which to base any extension to the pattern that I might need later on.

How easy it will be to introduce a hierarchy or taxonomy of events at a later stage remains to be seen; I don't think it will be particularly easy.  However, my needs are fairly simple at this stage, and although the plug-in framework is intended to be generic, it's still tied to the personal finance program I'm trying to build.  One of my goals is to completely decouple the framework from the program, but we shall see how easy this is.  With the message passing problem solved, I now need to catch up on <a href="http://trac.alastairsmith.me.uk/FinanceProg/roadmap" title="FinanceProg Roadmap">lost time</a>.
</EventInfo></EventInfo></blockcode>

          </div>

          <div class="article-share">
            
            <a href="" title="Share on Twitter" onclick="window.open('https://twitter.com/home?status=Message Passing 2 - http://codebork.com/2008/07/31/message-passing-2.html by @alastairs', 'newwindow', 'width=500, height=225'); return false;">
              <span class="icon icon-social-twitter"></span>
            </a>
            <a href="" title="Share on Facebook" onclick="window.open('https://www.facebook.com/sharer/sharer.php?u=http://codebork.com/2008/07/31/message-passing-2.html', 'newwindow', 'width=500, height=500'); return false;">
              <span class="icon icon-social-facebook"></span>
            </a>
            <a href="" title="Share on Google+" onclick="window.open('https://plus.google.com/share?url=http://codebork.com/2008/07/31/message-passing-2.html', 'newwindow', 'width=550, height=400'); return false;">
              <span class="icon icon-social-googleplus"></span>
            </a>
          </div>

          
        </article>
        <footer class="footer reveal">
  <p>
    Chalk is a high quality, completely customisable, performant and 100% free
    blog template for Jekyll built by
    <a href="/about" title="About me">Nielsen Ramon</a>. Download it <a href="https://github.com/nielsenramon/chalk" target="_blank" title="Download Chalk">here</a>.
  </p>
</footer>

      </div>
    </div>
  </main>
  <script type="text/javascript" src="/assets/vendor.js"></script>
<script type="text/javascript" src="/assets/application.js"></script>

<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.16/webfont.js"></script>
<script>
  WebFont.load({
    google: {
      families: ['Cormorant Garamond:700', 'Lato:300,400,700']
    }
  });
</script>



</body>
</html>
